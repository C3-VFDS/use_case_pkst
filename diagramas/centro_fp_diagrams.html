<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backend EAC â€” Nodo Central</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { overflow-x: hidden; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.04); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SHARED STYLES / PRIMITIVES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const METHOD_COLORS = {
      GET:    { bg: "#e3f2fd", text: "#1565c0", border: "#1565c0" },
      POST:   { bg: "#e8f5e9", text: "#2e7d32", border: "#2e7d32" },
      PUT:    { bg: "#fff8e1", text: "#f57f17", border: "#f57f17" },
      DELETE: { bg: "#ffebee", text: "#c62828", border: "#c62828" },
    };

    const CONSUMERS_META = {
      LMS:             { label: "LMS (Moodle)",        color: "#f57f17", bg: "#fff8e1", textColor: "#e65100" },
      APP_LTI:         { label: "APP_LTI",             color: "#1565c0", bg: "#e3f2fd", textColor: "#0d47a1" },
      ANON:            { label: "Aggregator/Anonymizer",color: "#00695c", bg: "#e0f2f1", textColor: "#004d40" },
      RETRY:           { label: "Retry Worker",         color: "#6a1b9a", bg: "#f3e5f5", textColor: "#4a148c" },
      CONNECTOR_CFP:   { label: "CONNECTOR_CFP",        color: "#c62828", bg: "#ffebee", textColor: "#b71c1c" },
      CONNECTOR_CENTRAL:{ label: "CONNECTOR_CENTRAL",  color: "#880e4f", bg: "#fce4ec", textColor: "#880e4f" },
      LOCALDB:         { label: "LOCALDB (PostgreSQL)", color: "#4e342e", bg: "#efebe9", textColor: "#3e2723" },
      OPERATOR:        { label: "Operador",             color: "#546e7a", bg: "#eceff1", textColor: "#263238" },
      STUDENT:         { label: "Estudiante",           color: "#2e7d32", bg: "#e8f5e9", textColor: "#1b5e20" },
      TEACHER:         { label: "Docente",              color: "#4527a0", bg: "#ede7f6", textColor: "#311b92" },
    };

    function MethodBadge({ method }) {
      const c = METHOD_COLORS[method] || METHOD_COLORS.GET;
      return (
        <span style={{
          display: "inline-block", padding: "1px 7px", borderRadius: "3px",
          fontSize: "10px", fontWeight: "800",
          background: c.bg, color: c.text, border: `1.5px solid ${c.border}`,
          fontFamily: "'DM Mono', monospace", letterSpacing: "0.05em", flexShrink: 0,
        }}>{method}</span>
      );
    }

    function ConsumerBadge({ id }) {
      const c = CONSUMERS_META[id];
      if (!c) return null;
      return (
        <span style={{
          display: "inline-block", padding: "2px 8px", borderRadius: "12px",
          fontSize: "10px", fontWeight: "600",
          background: c.bg, color: c.textColor, border: `1px solid ${c.color}`,
          marginRight: "4px", marginBottom: "3px", fontFamily: "'DM Mono', monospace",
        }}>{c.label}</span>
      );
    }

    function InfraTag({ id }) {
      const c = CONSUMERS_META[id];
      if (!c) return null;
      return (
        <span style={{
          display: "inline-flex", alignItems: "center", padding: "2px 7px",
          borderRadius: "4px", fontSize: "10px", fontWeight: "700",
          background: c.bg, color: c.textColor, border: `1px solid ${c.color}`,
          marginRight: "4px", marginBottom: "2px", fontFamily: "'DM Mono', monospace",
        }}>{id}</span>
      );
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // DIAGRAM 1 â€” MODULES + ENDPOINTS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const MODULES = [
      {
        id: "APP_LTI",
        icon: "ğŸ“±",
        title: "APP_LTI",
        subtitle: "Frontend EAC embebido en Moodle vÃ­a LTI 1.3",
        color: "#1565c0",
        bg: "#e3f2fd",
        border: "#90caf9",
        description: "SPA React servida dentro del LMS mediante LTI 1.3. Gestiona la vista del estudiante (panel de nodos, envÃ­o de evidencias) y la vista del docente (panel de clase). Contiene la lÃ³gica de mapeo anon_id â†” student_id, que nunca abandona el perÃ­metro del centro.",
        tech: "React 18+ Â· D3.js / Cytoscape.js Â· Recharts Â· LTI 1.3",
        note: null,
        endpoints: [
          {
            method: "POST", path: "/lti/launch",
            desc: "Punto de entrada LTI 1.3. Recibe el JWT de lanzamiento firmado por el LMS con student_id, course_id y rol.",
            consumes: ["LMS"],
            produces: "SesiÃ³n autenticada + SPA React renderizada"
          },
          {
            method: "GET", path: "/api/student/panel",
            desc: "Solicita el panel competencial del estudiante al Nodo Central (a travÃ©s de CONNECTOR_CFP). Internamente usa el anon_id ya calculado.",
            consumes: ["STUDENT"],
            produces: "perfil_habilitacion[] + SC_recomendada (reidentificado localmente)"
          },
          {
            method: "POST", path: "/api/student/submit",
            desc: "El estudiante envÃ­a la resoluciÃ³n de una SC. APP_LTI invoca al Anonymizer antes de forwarding hacia CONNECTOR_CFP.",
            consumes: ["STUDENT"],
            produces: "Inicia flujo: APP_LTI â†’ ANON â†’ CONNECTOR_CFP â†’ CONNECTOR_CENTRAL"
          },
          {
            method: "POST", path: "/api/evaluation/result",
            desc: "Endpoint de callback interno. Recibe el resultado de evaluaciÃ³n procedente de CONNECTOR_CFP (score, gradiente_autonomia, diagnostico, nueva_SC_recomendada).",
            consumes: ["CONNECTOR_CFP"],
            produces: "Actualiza UI del estudiante + llama a LMS Grade Passback"
          },
          {
            method: "GET", path: "/api/teacher/class",
            desc: "Panel docente: estado competencial agregado del grupo, SCs en curso, bloqueos detectados.",
            consumes: ["TEACHER"],
            produces: "class_summary[] con perfil_habilitacion por anon_id (reidentificado)"
          },
          {
            method: "POST", path: "/lti/grade-passback",
            desc: "Devuelve la calificaciÃ³n (Gradiente de AutonomÃ­a) al libro de calificaciones del LMS mediante LTI Advantage Assignment & Grades Service.",
            consumes: ["APP_LTI"],
            produces: "Grade registrado en Moodle Gradebook"
          },
        ],
        reads: ["LOCALDB"],
        writes: ["LOCALDB"],
      },
      {
        id: "ANON",
        icon: "ğŸ”’",
        title: "Aggregator / Anonymizer",
        subtitle: "Frontera estricta de PII antes de salir del perÃ­metro",
        color: "#00695c",
        bg: "#e0f2f1",
        border: "#80cbc4",
        description: "MÃ³dulo independiente con API REST propia. Elimina PII (nombre, email, ID real, IP) y genera un hash irreversible por estudiante y contexto. Gestiona el mapeo bidireccional y mantiene la tabla de correspondencias en LOCALDB. TambiÃ©n actÃºa como responsable de encolar submissions fallidas en la cola de reintentos.",
        tech: "Python / Node.js Â· HMAC-SHA256 Â· PostgreSQL",
        note: null,
        endpoints: [
          {
            method: "POST", path: "/api/v1/anonymize",
            desc: "Seudonimiza la identidad del estudiante para una sesiÃ³n. Genera o recupera el anon_id correspondiente al par (student_id, context_id).",
            consumes: ["APP_LTI"],
            produces: "{ anon_id } â€” hash irreversible"
          },
          {
            method: "POST", path: "/api/v1/anonymize/submission",
            desc: "Seudonimiza una evidencia completa antes de enviarla al Nodo Central. Elimina PII del cuerpo, adjuntos y metadatos.",
            consumes: ["APP_LTI"],
            produces: "{ anon_id, evidencia_seudonimizada }"
          },
          {
            method: "GET", path: "/api/v1/deanonymize/{anon_id}",
            desc: "Mapeo inverso: recupera el student_id original a partir del anon_id. Solo accesible desde APP_LTI dentro del perÃ­metro del centro.",
            consumes: ["APP_LTI"],
            produces: "{ student_id } â€” nunca expuesto fuera del centro"
          },
          {
            method: "POST", path: "/api/v1/retry/enqueue",
            desc: "Encola una submission fallida (timeout, CONNECTOR_CFP no disponible) para reintento posterior.",
            consumes: ["APP_LTI"],
            produces: "{ queue_id, retry_after }"
          },
          {
            method: "GET", path: "/api/v1/health",
            desc: "Health check del mÃ³dulo: estado de la BD local, tamaÃ±o de la cola de reintentos.",
            consumes: ["OPERATOR"],
            produces: "{ status, queue_size, db_ok }"
          },
        ],
        reads: ["LOCALDB"],
        writes: ["LOCALDB"],
      },
      {
        id: "RETRY",
        icon: "ğŸ”„",
        title: "Retry Worker",
        subtitle: "Daemon de reintentos para submissions fallidas",
        color: "#6a1b9a",
        bg: "#f3e5f5",
        border: "#ce93d8",
        description: "Proceso daemon (Celery Beat o cron) que monitoriza la tabla submission_queue en LOCALDB. Reintenta periÃ³dicamente el envÃ­o de evidencias que fallaron por indisponibilidad de CONNECTOR_CFP. Implementa backoff exponencial y marca como fallido definitivo tras N intentos, notificando al docente.",
        tech: "Celery Beat / cron Â· Python Â· SQLAlchemy",
        note: "No expone una API REST pÃºblica. Sus interfaces son: lectura/escritura en LOCALDB y llamadas salientes a CONNECTOR_CFP.",
        endpoints: [
          {
            method: "GET", path: "/api/v1/retry/queue",
            desc: "Lista submissions pendientes en cola (estado, intentos realizados, prÃ³ximo reintento). Solo accesible internamente.",
            consumes: ["OPERATOR"],
            produces: "submission_queue[] con estado y timestamps"
          },
          {
            method: "POST", path: "/api/v1/retry/process",
            desc: "Disparo manual del ciclo de reintentos (normalmente lo ejecuta el scheduler automÃ¡ticamente).",
            consumes: ["OPERATOR"],
            produces: "{ processed, succeeded, failed, pending }"
          },
          {
            method: "DELETE", path: "/api/v1/retry/queue/{queue_id}",
            desc: "Elimina una entrada de la cola (cuando el docente decide descartar una submission fallida).",
            consumes: ["TEACHER"],
            produces: "{ deleted: true }"
          },
        ],
        reads: ["LOCALDB"],
        writes: ["LOCALDB", "CONNECTOR_CFP"],
      },
      {
        id: "CONNECTOR_CFP",
        icon: "ğŸ”—",
        title: "CONNECTOR_CFP",
        subtitle: "Frontera de soberanÃ­a del dato del centro â€” caja negra",
        color: "#c62828",
        bg: "#ffebee",
        border: "#ef9a9a",
        description: "Instancia local del FIWARE Dataspace Connector (Eclipse EDC). ActÃºa como frontera de soberanÃ­a del dato del centro: todo trÃ¡fico hacia el Nodo Central pasa por aquÃ­. Negocia acuerdos ODRL con CONNECTOR_CENTRAL, autentica mediante API Key y garantiza que los datos seudonimizados viajan bajo contrato. En sentido inverso, entrega resultados a APP_LTI y al Retry Worker.",
        tech: "Eclipse EDC (FIWARE fork) Â· ODRL Â· HTTPS/TLS",
        note: "Modelado como caja negra. Se muestran Ãºnicamente sus interfaces visibles desde el software del centro.",
        endpoints: [
          {
            method: "POST", path: "â†’ [salida] /negotiate",
            desc: "Negocia acuerdo ODRL con CONNECTOR_CENTRAL presentando la API Key del centro. (Interfaz saliente hacia el Nodo Central.)",
            consumes: ["APP_LTI", "RETRY"],
            produces: "Acuerdo ODRL activo + token de transferencia"
          },
          {
            method: "POST", path: "â†’ [salida] /transfer",
            desc: "Transmite datos seudonimizados al Nodo Central bajo el acuerdo ODRL negociado.",
            consumes: ["APP_LTI", "RETRY"],
            produces: "{ transfer_id } â€” respuesta asÃ­ncrona"
          },
          {
            method: "POST", path: "â† [entrada] /callback/result",
            desc: "Recibe desde CONNECTOR_CENTRAL el resultado de la evaluaciÃ³n y lo enruta a APP_LTI.",
            consumes: ["CONNECTOR_CENTRAL"],
            produces: "{ score, gradiente_autonomia, diagnostico, nueva_SC_recomendada }"
          },
        ],
        reads: [],
        writes: [],
      },
    ];

    function ModuleCard({ mod }) {
      const [expanded, setExpanded] = useState(true);
      return (
        <div style={{
          background: "white",
          border: `2px solid ${mod.border}`,
          borderRadius: "14px",
          overflow: "hidden",
          boxShadow: "0 2px 12px rgba(0,0,0,0.07)",
        }}>
          {/* Header */}
          <div
            onClick={() => setExpanded(e => !e)}
            style={{
              background: mod.bg,
              padding: "14px 18px",
              display: "flex", alignItems: "center", gap: "10px",
              borderBottom: `2px solid ${mod.border}`,
              cursor: "pointer", userSelect: "none",
            }}
          >
            <span style={{ fontSize: "22px" }}>{mod.icon}</span>
            <div style={{ flex: 1 }}>
              <div style={{
                fontFamily: "'Syne', sans-serif", fontWeight: "800",
                fontSize: "15px", color: mod.color, letterSpacing: "-0.02em",
              }}>{mod.title}</div>
              <div style={{
                fontSize: "10.5px", color: "#666", fontFamily: "'DM Sans', sans-serif",
              }}>{mod.subtitle}</div>
            </div>
            <div style={{
              fontSize: "11px", fontWeight: "700",
              color: mod.color, background: "white",
              padding: "2px 10px", borderRadius: "20px",
              border: `1px solid ${mod.border}`,
              fontFamily: "'DM Mono', monospace", marginRight: "8px",
            }}>
              {mod.endpoints.length} endpoints
            </div>
            <span style={{ color: mod.color, fontSize: "14px" }}>{expanded ? "â–²" : "â–¼"}</span>
          </div>

          {expanded && (
            <div style={{ padding: "16px 18px" }}>
              <p style={{
                fontSize: "12px", lineHeight: "1.65", color: "#444",
                margin: "0 0 10px", fontFamily: "'DM Sans', sans-serif",
              }}>{mod.description}</p>

              {mod.note && (
                <div style={{
                  background: "#fffde7", border: "1px solid #f9a825",
                  borderRadius: "6px", padding: "7px 10px", marginBottom: "12px",
                  fontSize: "11px", color: "#e65100", fontFamily: "'DM Mono', monospace",
                }}>âš ï¸ {mod.note}</div>
              )}

              <div style={{ marginBottom: "10px" }}>
                <span style={{
                  fontSize: "10px", fontWeight: "700", color: mod.color,
                  fontFamily: "'DM Mono', monospace", letterSpacing: "0.06em",
                  textTransform: "uppercase",
                }}>TECH: </span>
                <span style={{ fontSize: "11px", color: "#555", fontFamily: "'DM Mono', monospace" }}>
                  {mod.tech}
                </span>
              </div>

              <div style={{
                fontSize: "10px", fontWeight: "700", color: "#999",
                fontFamily: "'DM Mono', monospace", letterSpacing: "0.08em",
                textTransform: "uppercase", marginBottom: "8px",
              }}>ENDPOINTS</div>

              <div style={{ display: "flex", flexDirection: "column", gap: "8px" }}>
                {mod.endpoints.map((ep, i) => (
                  <div key={i} style={{
                    background: "#fafafa", border: "1px solid #eee",
                    borderRadius: "8px", padding: "10px 12px",
                    borderLeft: `3px solid ${mod.color}`,
                  }}>
                    <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "4px", flexWrap: "wrap" }}>
                      <MethodBadge method={ep.method} />
                      <code style={{
                        fontSize: "11px", fontFamily: "'DM Mono', monospace",
                        color: "#1a1a2e", fontWeight: "600",
                        background: "#f0f0f0", padding: "1px 6px", borderRadius: "3px",
                      }}>{ep.path}</code>
                    </div>
                    <p style={{
                      margin: "0 0 6px", fontSize: "11.5px", color: "#555",
                      fontFamily: "'DM Sans', sans-serif", lineHeight: "1.45",
                    }}>{ep.desc}</p>
                    <div style={{ marginBottom: "3px" }}>
                      <span style={{
                        fontSize: "10px", color: "#aaa", fontWeight: "600",
                        fontFamily: "'DM Mono', monospace", textTransform: "uppercase",
                        letterSpacing: "0.06em", marginRight: "6px",
                      }}>CONSUME:</span>
                      {ep.consumes.map(c => <ConsumerBadge key={c} id={c} />)}
                    </div>
                    <div>
                      <span style={{
                        fontSize: "10px", color: "#aaa", fontWeight: "600",
                        fontFamily: "'DM Mono', monospace", textTransform: "uppercase",
                        letterSpacing: "0.06em", marginRight: "6px",
                      }}>PRODUCE:</span>
                      <span style={{
                        fontSize: "10.5px", color: "#666", fontFamily: "'DM Mono', monospace",
                        fontStyle: "italic",
                      }}>{ep.produces}</span>
                    </div>
                  </div>
                ))}
              </div>

              {(mod.reads.length > 0 || mod.writes.length > 0) && (
                <div style={{ marginTop: "12px", display: "flex", gap: "14px", flexWrap: "wrap" }}>
                  {mod.reads.length > 0 && (
                    <div>
                      <span style={{
                        fontSize: "10px", color: "#1565c0", fontWeight: "700",
                        fontFamily: "'DM Mono', monospace", textTransform: "uppercase",
                        letterSpacing: "0.06em",
                      }}>READ â†— </span>
                      {mod.reads.map(r => <InfraTag key={r} id={r} />)}
                    </div>
                  )}
                  {mod.writes.length > 0 && (
                    <div>
                      <span style={{
                        fontSize: "10px", color: "#c62828", fontWeight: "700",
                        fontFamily: "'DM Mono', monospace", textTransform: "uppercase",
                        letterSpacing: "0.06em",
                      }}>WRITE â†™ </span>
                      {mod.writes.map(w => <InfraTag key={w} id={w} />)}
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    function DiagramModules() {
      return (
        <div style={{ padding: "28px 36px", maxWidth: "1000px", margin: "0 auto" }}>
          <div style={{ display: "flex", flexDirection: "column", gap: "18px" }}>
            {MODULES.map(mod => <ModuleCard key={mod.id} mod={mod} />)}
          </div>
          {/* External entities bar */}
          <div style={{
            marginTop: "24px",
            background: "rgba(255,255,255,0.05)",
            border: "1px solid rgba(255,255,255,0.1)",
            borderRadius: "10px", padding: "14px 18px",
          }}>
            <div style={{
              color: "rgba(255,255,255,0.4)", fontSize: "10px",
              fontFamily: "'DM Mono', monospace", fontWeight: "700",
              textTransform: "uppercase", letterSpacing: "0.1em",
              marginBottom: "10px",
            }}>Entidades externas al software del centro</div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
              {["LMS", "CONNECTOR_CENTRAL", "STUDENT", "TEACHER", "OPERATOR"].map(id => {
                const c = CONSUMERS_META[id];
                return (
                  <span key={id} style={{
                    padding: "3px 10px", borderRadius: "4px",
                    fontSize: "10.5px", fontWeight: "600",
                    background: `${c.bg}22`, color: c.color,
                    border: `1px solid ${c.color}55`,
                    fontFamily: "'DM Mono', monospace",
                  }}>{c.label}</span>
                );
              })}
              <span style={{
                padding: "3px 10px", borderRadius: "4px",
                fontSize: "10.5px", fontWeight: "600",
                background: "rgba(255,255,255,0.05)", color: "rgba(255,255,255,0.4)",
                border: "1px solid rgba(255,255,255,0.12)",
                fontFamily: "'DM Mono', monospace",
              }}>ğŸ’¼ Wallet / VC Agent</span>
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // DIAGRAM 2 â€” DEPENDENCY FLOW (SVG)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const W = 860, H = 580;

    const FLOW_NODES = {
      LMS:      { x: 30,  y: 240, w: 110, h: 50, icon: "ğŸ“š", label: "LMS",      sub: "Moodle 4.x",                  color: "#f57f17", bg: "#fff8e1", kind: "external" },
      STUDENT:  { x: 30,  y: 50,  w: 110, h: 50, icon: "ğŸ‘¨â€ğŸ“", label: "Estudiante", sub: "actor",                    color: "#2e7d32", bg: "#e8f5e9", kind: "actor" },
      TEACHER:  { x: 30,  y: 420, w: 110, h: 50, icon: "ğŸ‘¨â€ğŸ«", label: "Docente",   sub: "actor",                     color: "#4527a0", bg: "#ede7f6", kind: "actor" },
      APP_LTI:  { x: 230, y: 150, w: 140, h: 50, icon: "ğŸ“±", label: "APP_LTI",  sub: "React SPA + LTI server",       color: "#1565c0", bg: "#e3f2fd", kind: "internal" },
      ANON:     { x: 450, y: 50,  w: 155, h: 50, icon: "ğŸ”’", label: "Anonymizer", sub: "seudonimizaciÃ³n",            color: "#00695c", bg: "#e0f2f1", kind: "internal" },
      RETRY:    { x: 450, y: 420, w: 155, h: 50, icon: "ğŸ”„", label: "Retry Worker", sub: "cola de reintentos",       color: "#6a1b9a", bg: "#f3e5f5", kind: "internal" },
      LOCALDB:  { x: 450, y: 240, w: 155, h: 50, icon: "ğŸ˜", label: "LOCALDB",  sub: "PostgreSQL Â· PII",             color: "#4e342e", bg: "#efebe9", kind: "storage" },
      CONN_CFP: { x: 680, y: 240, w: 155, h: 50, icon: "ğŸ”—", label: "CONNECTOR_CFP", sub: "caja negra Â· ODRL",      color: "#c62828", bg: "#ffebee", kind: "gateway" },
      CONN_CEN: { x: 680, y: 430, w: 155, h: 50, icon: "ğŸ”—", label: "CONNECTOR_CENTRAL", sub: "Nodo Central",       color: "#880e4f", bg: "#fce4ec", kind: "external" },
    };

    const FLOW_EDGES = [
      // LTI launch
      { from: "LMS",      to: "APP_LTI",  label: "POST /lti/launch",          flow: "lti",     bidir: false },
      { from: "STUDENT",  to: "APP_LTI",  label: "accede al panel",           flow: "lti",     bidir: false },
      { from: "TEACHER",  to: "APP_LTI",  label: "accede al panel docente",   flow: "lti",     bidir: false },
      // Anonymization
      { from: "APP_LTI",  to: "ANON",    label: "POST /anonymize Â· /submission", flow: "anon", bidir: false },
      { from: "ANON",     to: "APP_LTI", label: "{ anon_id } / evidencia_seud.",  flow: "anon", bidir: false },
      { from: "ANON",     to: "LOCALDB", label: "R/W mapping anonâ†”student",   flow: "anon",    bidir: true  },
      // Submission flow
      { from: "APP_LTI",  to: "CONN_CFP", label: "submit vÃ­a CONNECTOR_CFP", flow: "submit",  bidir: false },
      { from: "CONN_CFP", to: "CONN_CEN", label: "ODRL transfer (seudonimizado)", flow: "submit", bidir: false },
      { from: "CONN_CEN", to: "CONN_CFP", label: "resultado evaluaciÃ³n",      flow: "submit",  bidir: false },
      { from: "CONN_CFP", to: "APP_LTI",  label: "POST /api/evaluation/result", flow: "submit", bidir: false },
      // Retry flow
      { from: "APP_LTI",  to: "ANON",    label: "POST /retry/enqueue",        flow: "retry",   bidir: false },
      { from: "ANON",     to: "LOCALDB", label: "INSERT submission_queue",    flow: "retry",   bidir: false },
      { from: "RETRY",    to: "LOCALDB", label: "R/W submission_queue",       flow: "retry",   bidir: true  },
      { from: "RETRY",    to: "CONN_CFP", label: "reenvÃ­o con backoff",       flow: "retry",   bidir: false },
      // Grade passback
      { from: "APP_LTI",  to: "LMS",     label: "LTI Grade Passback",        flow: "grade",   bidir: false },
      // Local storage
      { from: "APP_LTI",  to: "LOCALDB", label: "sesiÃ³n Â· mapeo local",      flow: "storage", bidir: true  },
    ];

    const FLOW_META = [
      { id: "all",     label: "Todos los flujos",       color: "#607d8b", icon: "â¬¡" },
      { id: "lti",     label: "Lanzamiento LTI",         color: "#f57f17", icon: "ğŸ“š" },
      { id: "anon",    label: "SeudonimizaciÃ³n",          color: "#00695c", icon: "ğŸ”’" },
      { id: "submit",  label: "EnvÃ­o de evidencia",       color: "#c62828", icon: "ğŸ“¤" },
      { id: "retry",   label: "Cola de reintentos",       color: "#6a1b9a", icon: "ğŸ”„" },
      { id: "grade",   label: "Grade Passback",           color: "#f57f17", icon: "ğŸ“Š" },
      { id: "storage", label: "Persistencia local",       color: "#4e342e", icon: "ğŸ—„ï¸" },
    ];

    const EDGE_COLORS = {
      lti:     "#f57f17",
      anon:    "#00897b",
      submit:  "#e53935",
      retry:   "#8e24aa",
      grade:   "#fb8c00",
      storage: "#6d4c41",
    };

    function nodeCenter(id) {
      const n = FLOW_NODES[id];
      return { x: n.x + n.w / 2, y: n.y + n.h / 2 };
    }

    function calcPath(fromId, toId, offset = 0) {
      const a = nodeCenter(fromId);
      const b = nodeCenter(toId);
      const dx = b.x - a.x, dy = b.y - a.y;
      const len = Math.sqrt(dx * dx + dy * dy) || 1;
      const ux = dx / len, uy = dy / len;
      const ox = -uy * offset * 9, oy = ux * offset * 9;
      const pad = 30;
      const sx = a.x + ux * pad + ox, sy = a.y + uy * pad + oy;
      const ex = b.x - ux * pad + ox, ey = b.y - uy * pad + oy;
      const mx = (sx + ex) / 2 + ox * 1.5, my = (sy + ey) / 2 + oy * 1.5;
      return { path: `M ${sx} ${sy} Q ${mx} ${my} ${ex} ${ey}`, mx, my };
    }

    function FlowArrow({ edge, idx, activeFlow, hoveredEdge, setHoveredEdge }) {
      const isActive = activeFlow === "all" || edge.flow === activeFlow;
      const isHovered = hoveredEdge === idx;
      const color = EDGE_COLORS[edge.flow];
      const { path, mx, my } = calcPath(edge.from, edge.to, idx % 3 - 1);
      const markId = `arr-cfp-${idx}`;

      return (
        <g opacity={isActive ? 1 : 0.07}
          style={{ cursor: "pointer" }}
          onMouseEnter={() => setHoveredEdge(idx)}
          onMouseLeave={() => setHoveredEdge(null)}>
          <defs>
            <marker id={markId} markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto">
              <path d="M0,0 L0,6 L7,3 z" fill={color} />
            </marker>
          </defs>
          <path d={path} fill="none" stroke="transparent" strokeWidth="14" />
          <path d={path} fill="none" stroke={color}
            strokeWidth={isHovered ? 3 : isActive ? 2 : 1.5}
            strokeDasharray={edge.flow === "storage" ? "5,3" : "none"}
            markerEnd={`url(#${markId})`} />
          {(isActive || isHovered) && (
            <text x={mx} y={my - 5} textAnchor="middle"
              style={{
                fontSize: "8px", fontFamily: "'DM Mono', monospace",
                fill: color, fontWeight: "700",
                filter: "drop-shadow(0 1px 2px rgba(0,0,0,0.5))",
                pointerEvents: "none",
              }}>{edge.label}</text>
          )}
        </g>
      );
    }

    function FlowNode({ id, activeFlow, selectedNode, setSelectedNode }) {
      const n = FLOW_NODES[id];
      const isSelected = selectedNode === id;
      const isConnected = selectedNode && FLOW_EDGES.some(e =>
        (e.from === selectedNode && e.to === id) ||
        (e.to === selectedNode && e.from === id)
      );
      const dim = selectedNode && !isSelected && !isConnected;

      return (
        <g transform={`translate(${n.x}, ${n.y})`}
          style={{ cursor: "pointer" }}
          onClick={() => setSelectedNode(selectedNode === id ? null : id)}>
          <rect x="2" y="3" width={n.w} height={n.h} rx="10" fill="rgba(0,0,0,0.18)" />
          <rect x="0" y="0" width={n.w} height={n.h} rx="10"
            fill={isSelected ? n.color : "white"}
            stroke={isSelected || isConnected ? n.color : "#ddd"}
            strokeWidth={isSelected || isConnected ? 2.5 : 1}
            opacity={dim ? 0.2 : 1} />
          <rect x="0" y="0" width="4" height={n.h} rx="2" fill={n.color} opacity={dim ? 0.1 : 0.7} />
          <text x="14" y="22" style={{ fontSize: "14px", pointerEvents: "none" }}>{n.icon}</text>
          <text x="32" y="22" style={{
            fontSize: "10.5px", fontFamily: "'Syne', sans-serif", fontWeight: "800",
            fill: isSelected ? "white" : n.color, pointerEvents: "none",
          }}>{n.label}</text>
          <text x="10" y="38" style={{
            fontSize: "8.5px", fontFamily: "'DM Mono', monospace",
            fill: isSelected ? "rgba(255,255,255,0.75)" : "#999", pointerEvents: "none",
          }}>{n.sub}</text>
          {(n.kind === "external" || n.kind === "actor") && (
            <>
              <rect x={n.w - 38} y="4" width="32" height="12" rx="6" fill={`${n.color}20`} />
              <text x={n.w - 22} y="13" textAnchor="middle"
                style={{ fontSize: "7px", fontFamily: "'DM Mono', monospace", fill: n.color, fontWeight: "700", pointerEvents: "none" }}>
                {n.kind === "actor" ? "ACTOR" : "EXT"}
              </text>
            </>
          )}
        </g>
      );
    }

    function DiagramFlow() {
      const [activeFlow, setActiveFlow] = useState("all");
      const [hoveredEdge, setHoveredEdge] = useState(null);
      const [selectedNode, setSelectedNode] = useState(null);

      const nodeEdgesOut = selectedNode ? FLOW_EDGES.filter(e => e.from === selectedNode) : [];
      const nodeEdgesIn  = selectedNode ? FLOW_EDGES.filter(e => e.to   === selectedNode) : [];

      return (
        <div style={{ display: "flex", flex: 1, overflow: "hidden" }}>
          {/* SVG */}
          <div style={{ flex: 1, overflow: "auto", padding: "24px", display: "flex", justifyContent: "center" }}>
            {/* Flow filter buttons */}
            <div style={{ display: "flex", flexDirection: "column", gap: "20px", alignItems: "flex-start", width: "100%", maxWidth: W + 40 }}>
              <div style={{ display: "flex", gap: "6px", flexWrap: "wrap" }}>
                {FLOW_META.map(f => (
                  <button key={f.id} onClick={() => { setActiveFlow(f.id); setSelectedNode(null); }} style={{
                    padding: "5px 12px", borderRadius: "20px",
                    border: `1px solid ${activeFlow === f.id ? f.color : "rgba(255,255,255,0.12)"}`,
                    background: activeFlow === f.id ? `${f.color}22` : "rgba(255,255,255,0.04)",
                    color: activeFlow === f.id ? f.color : "rgba(255,255,255,0.5)",
                    cursor: "pointer", fontSize: "11px", fontWeight: "600",
                    fontFamily: "'DM Mono', monospace", transition: "all 0.15s",
                    display: "flex", alignItems: "center", gap: "5px",
                  }}>
                    <span>{f.icon}</span><span>{f.label}</span>
                    {f.id !== "all" && (
                      <span style={{
                        background: `${f.color}33`, color: f.color,
                        borderRadius: "10px", padding: "0 6px", fontSize: "9px", fontWeight: "800",
                      }}>{FLOW_EDGES.filter(e => e.flow === f.id).length}</span>
                    )}
                  </button>
                ))}
              </div>

              <svg width={W} height={H} style={{
                background: "rgba(255,255,255,0.02)",
                borderRadius: "16px", border: "1px solid rgba(255,255,255,0.06)",
                minWidth: W,
              }}>
                <defs>
                  <pattern id="grid2" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(255,255,255,0.025)" strokeWidth="0.5"/>
                  </pattern>
                </defs>
                <rect width={W} height={H} fill="url(#grid2)" rx="16"/>

                {/* Zone labels */}
                {[
                  { x: 30, y: 14, label: "ACTORES" },
                  { x: 220, y: 14, label: "APP_LTI" },
                  { x: 440, y: 14, label: "MÃ“DULOS LOCALES" },
                  { x: 670, y: 14, label: "DATASPACE" },
                ].map(z => (
                  <text key={z.x} x={z.x} y={z.y} style={{
                    fontSize: "8px", fill: "rgba(255,255,255,0.2)",
                    fontFamily: "'DM Mono', monospace", fontWeight: "700", letterSpacing: "0.08em",
                  }}>{z.label}</text>
                ))}

                {/* Vertical separators */}
                {[210, 440, 665].map(x => (
                  <line key={x} x1={x} y1={20} x2={x} y2={H - 16}
                    stroke="rgba(255,255,255,0.05)" strokeWidth="1" strokeDasharray="4,4" />
                ))}

                {/* Perimeter boundary */}
                <rect x="220" y="22" width={440} height={H - 44} rx="10"
                  fill="none" stroke="#f57f17" strokeWidth="1.5"
                  strokeDasharray="6,4" opacity="0.25" />
                <text x="228" y="36" style={{
                  fontSize: "8px", fill: "#f57f17", opacity: 0.5,
                  fontFamily: "'DM Mono', monospace", fontWeight: "700",
                }}>PERÃMETRO DEL CENTRO â€” PII nunca sale</text>

                {/* Edges */}
                {FLOW_EDGES.map((edge, i) => (
                  <FlowArrow key={i} edge={edge} idx={i} activeFlow={activeFlow}
                    hoveredEdge={hoveredEdge} setHoveredEdge={setHoveredEdge} />
                ))}

                {/* Nodes */}
                {Object.keys(FLOW_NODES).map(id => (
                  <FlowNode key={id} id={id} activeFlow={activeFlow}
                    selectedNode={selectedNode} setSelectedNode={setSelectedNode} />
                ))}

                {/* Legend */}
                <g transform={`translate(${W - 145}, ${H - 135})`}>
                  <rect width="138" height="128" rx="8"
                    fill="rgba(0,0,0,0.6)" stroke="rgba(255,255,255,0.1)" strokeWidth="1"/>
                  <text x="8" y="16" style={{ fontSize: "8px", fill: "rgba(255,255,255,0.4)",
                    fontFamily: "'DM Mono', monospace", fontWeight: "700", letterSpacing: "0.08em" }}>
                    LEYENDA FLUJOS
                  </text>
                  {Object.entries(EDGE_COLORS).map(([flow, color], i) => {
                    const f = FLOW_META.find(f => f.id === flow);
                    return (
                      <g key={flow} transform={`translate(8, ${25 + i * 17})`}>
                        <line x1="0" y1="5" x2="18" y2="5" stroke={color} strokeWidth="2"
                          strokeDasharray={flow === "storage" ? "4,2" : "none"} />
                        <text x="24" y="9" style={{ fontSize: "8px", fill: "rgba(255,255,255,0.6)",
                          fontFamily: "'DM Mono', monospace" }}>{f?.label}</text>
                      </g>
                    );
                  })}
                </g>

                <text x={W / 2} y={H - 6} textAnchor="middle"
                  style={{ fontSize: "9px", fill: "rgba(255,255,255,0.18)",
                    fontFamily: "'DM Mono', monospace" }}>
                  Haz clic en un nodo para ver sus conexiones
                </text>
              </svg>
            </div>
          </div>

          {/* Info panel */}
          <div style={{
            width: "260px", flexShrink: 0,
            borderLeft: "1px solid rgba(255,255,255,0.07)",
            background: "rgba(255,255,255,0.02)",
            overflowY: "auto", padding: "18px 14px",
            display: "flex", flexDirection: "column", gap: "12px",
          }}>
            {selectedNode ? (() => {
              const n = FLOW_NODES[selectedNode];
              return (
                <>
                  <div>
                    <div style={{ display: "flex", alignItems: "center", gap: "8px", marginBottom: "6px" }}>
                      <span style={{ fontSize: "20px" }}>{n.icon}</span>
                      <div>
                        <div style={{ fontFamily: "'Syne', sans-serif", fontWeight: "800", fontSize: "13px", color: n.color }}>{n.label}</div>
                        <div style={{ fontSize: "9.5px", color: "rgba(255,255,255,0.4)", fontFamily: "'DM Mono', monospace" }}>{n.sub}</div>
                      </div>
                    </div>
                  </div>
                  {nodeEdgesIn.length > 0 && (
                    <div>
                      <div style={{ fontSize: "9px", fontWeight: "700", color: "rgba(255,255,255,0.3)", fontFamily: "'DM Mono', monospace", textTransform: "uppercase", letterSpacing: "0.1em", marginBottom: "6px" }}>â† RECIBE DE</div>
                      {nodeEdgesIn.map((e, i) => (
                        <div key={i} style={{ padding: "7px 10px", marginBottom: "5px", borderRadius: "6px", background: `${EDGE_COLORS[e.flow]}18`, borderLeft: `3px solid ${EDGE_COLORS[e.flow]}` }}>
                          <div style={{ fontSize: "10px", fontWeight: "700", color: EDGE_COLORS[e.flow], fontFamily: "'Syne', sans-serif" }}>{FLOW_NODES[e.from]?.label}</div>
                          <div style={{ fontSize: "9px", color: "rgba(255,255,255,0.45)", fontFamily: "'DM Mono', monospace", marginTop: "2px" }}>{e.label}</div>
                        </div>
                      ))}
                    </div>
                  )}
                  {nodeEdgesOut.length > 0 && (
                    <div>
                      <div style={{ fontSize: "9px", fontWeight: "700", color: "rgba(255,255,255,0.3)", fontFamily: "'DM Mono', monospace", textTransform: "uppercase", letterSpacing: "0.1em", marginBottom: "6px" }}>â†’ ENVÃA A</div>
                      {nodeEdgesOut.map((e, i) => (
                        <div key={i} style={{ padding: "7px 10px", marginBottom: "5px", borderRadius: "6px", background: `${EDGE_COLORS[e.flow]}18`, borderLeft: `3px solid ${EDGE_COLORS[e.flow]}` }}>
                          <div style={{ fontSize: "10px", fontWeight: "700", color: EDGE_COLORS[e.flow], fontFamily: "'Syne', sans-serif" }}>{FLOW_NODES[e.to]?.label}</div>
                          <div style={{ fontSize: "9px", color: "rgba(255,255,255,0.45)", fontFamily: "'DM Mono', monospace", marginTop: "2px" }}>{e.label}</div>
                        </div>
                      ))}
                    </div>
                  )}
                  <button onClick={() => setSelectedNode(null)} style={{ marginTop: "auto", padding: "7px", borderRadius: "8px", border: "1px solid rgba(255,255,255,0.1)", background: "rgba(255,255,255,0.05)", color: "rgba(255,255,255,0.45)", cursor: "pointer", fontSize: "11px", fontFamily: "'DM Mono', monospace" }}>
                    Limpiar âœ•
                  </button>
                </>
              );
            })() : (
              <div style={{ color: "rgba(255,255,255,0.22)", fontSize: "11px", fontFamily: "'DM Mono', monospace", lineHeight: "1.7", paddingTop: "8px" }}>
                <div style={{ fontSize: "20px", marginBottom: "8px", opacity: 0.4 }}>ğŸ‘†</div>
                <strong style={{ color: "rgba(255,255,255,0.38)" }}>Selecciona un nodo</strong><br/>
                para ver sus conexiones entrantes y salientes.
                <br/><br/>
                <strong style={{ color: "rgba(255,255,255,0.38)" }}>Filtra por flujo</strong><br/>
                para aislar cada camino funcional.
              </div>
            )}
          </div>
        </div>
      );
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ROOT â€” Tab switcher
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function CentroFPDiagrams() {
      const [tab, setTab] = useState("modules");

      return (
        <div style={{
          minHeight: "100vh",
          background: "linear-gradient(160deg, #0d1117 0%, #161b22 60%, #0d1117 100%)",
          fontFamily: "'DM Sans', sans-serif",
          display: "flex", flexDirection: "column",
        }}>
          <style>{`
            @import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500;600&display=swap');
            * { box-sizing: border-box; }
            ::-webkit-scrollbar { width: 6px; height: 6px; }
            ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
            ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.14); border-radius: 3px; }
          `}</style>

          {/* Header */}
          <div style={{
            padding: "20px 32px 0",
            borderBottom: "1px solid rgba(255,255,255,0.07)",
            background: "rgba(255,255,255,0.02)",
            flexShrink: 0,
          }}>
            <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "16px" }}>
              <div style={{
                background: "linear-gradient(135deg, #f57f17, #c62828)",
                borderRadius: "10px", width: "36px", height: "36px",
                display: "flex", alignItems: "center", justifyContent: "center", fontSize: "18px",
              }}>ğŸ«</div>
              <div>
                <h1 style={{
                  fontFamily: "'Syne', sans-serif", fontWeight: "800",
                  fontSize: "20px", color: "white", margin: 0, letterSpacing: "-0.03em",
                }}>Nodo Centro FP â€” Software del Centro</h1>
                <p style={{
                  color: "rgba(255,255,255,0.4)", fontSize: "11px", margin: 0,
                  fontFamily: "'DM Mono', monospace",
                }}>
                  VOCATIONAL FEDERATED DATASPACE Â· {MODULES.length} mÃ³dulos Â· {FLOW_EDGES.length} dependencias
                </p>
              </div>
            </div>

            {/* Tabs */}
            <div style={{ display: "flex", gap: "0" }}>
              {[
                { id: "modules", label: "ğŸ“¦ MÃ³dulos y Endpoints" },
                { id: "flow",    label: "ğŸ”€ Diagrama de Dependencias" },
              ].map(t => (
                <button key={t.id} onClick={() => setTab(t.id)} style={{
                  padding: "10px 22px",
                  border: "none",
                  borderBottom: tab === t.id ? "3px solid #f57f17" : "3px solid transparent",
                  background: "transparent",
                  color: tab === t.id ? "#f57f17" : "rgba(255,255,255,0.4)",
                  cursor: "pointer", fontSize: "12px", fontWeight: "700",
                  fontFamily: "'DM Mono', monospace",
                  transition: "all 0.15s", letterSpacing: "0.02em",
                }}>{t.label}</button>
              ))}
            </div>
          </div>

          {/* Content */}
          <div style={{ flex: 1, overflow: "auto", display: "flex", flexDirection: "column" }}>
            {tab === "modules" ? <DiagramModules /> : <DiagramFlow />}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<CentroFPDiagrams />);
  </script>
</body>
</html>
